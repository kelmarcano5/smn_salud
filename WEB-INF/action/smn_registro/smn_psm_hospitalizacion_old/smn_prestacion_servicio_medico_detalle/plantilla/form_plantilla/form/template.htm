<!doctype html>
<html>

<head>

	<link rel="stylesheet" type="text/css" href="${def:context}/dinamica_bkp.css" />
	<link rel="stylesheet" type="text/css" href="${def:context}/main.css" />
	
	<script type="text/javascript" src="${def:context}/action/script">
	</script>
	<script type="text/javascript" src="${def:context}/action/jquery">
	</script>

	<script type="text/javascript">
		onload = function()
			{
				document.getElementById('cuestionario').style.width = '90%';
				document.getElementById('cuestionario').style.margin = 'auto';
				document.getElementById('cuestionario').style.marginTop = '20px';
				document.getElementById('cuestionario').style.border = '${fld:color_formulario}';
				document.getElementById('cuestionario').style.background = '${fld:cue_color_formulario}';
				document.getElementById('text_cue').style.fontSize = '${fld:tamano_letra2}';
				document.getElementById('text_cue').style.color = '${fld:cue_color_letra}';
				document.getElementById('text_cue').style.fontFamily = '${fld:cue_tipo_letra}';
				document.getElementById('text_cue').innerHTML = '${fld:cue_descripcion}';

				<row>
					addTable('seccion${fld:smn_rel_cuestionario_seccion_id}');
					// Llama a addRow() con el ID de la tabla 
					addRow('seccion${fld:smn_rel_cuestionario_seccion_id}','${fld:seccion_combo}','${fld:rcs_color_sombreado}','${fld:rcs_tipo_letra}','${fld:rcs_color_letra}','${fld:tamano_letra}','${fld:identacion}','${fld:smn_rel_cuestionario_seccion_id}');
					getPreguntas('${fld:smn_rel_cuestionario_seccion_id}','${fld:seccion_combo}');

				</row>
			}

		//invoca la generacion de un PDF en un popup
		function openPDF()
		{
			var features = "height=500,width=800,status=no,toolbar=no,menubar=no,location=no,scrollbars=yes,resizable=yes";
			var url = "${def:context}${def:actionroot}/pdf?random=" + Math.random();
			var w = window.open(url, null, features);
		}
		
		function getPreguntas(id,text)
		{
			if (id!=null && id!="") 
			{
				return ajaxCall(	
							httpMethod="GET", 
							uri="${def:actionroot}/form/preguntas?id=" +id+"&seccion="+text, 
							divResponse=null, 
							divProgress="status", 
							formName=null, 
							afterResponseFn=null, //function 'setElementFirstIndex' select first element of combo list
							onErrorFn=null);				
			}
		
		}

		function addTable(id) 
		{
			var body = document.getElementsByTagName("body")[0];
			var seccion = document.getElementById('seccion');
			var tabla = document.createElement("table");
			var tblBody = document.createElement("tbody");
			tabla.appendChild(tblBody);
			body.appendChild(tabla);
			tabla.setAttribute("id",id);
			tabla.setAttribute("style","width:100%;");
			seccion.appendChild(tabla);
		}

		function addRow(tableID,texto,background,text_font,text_color,size,indent,seccion_id) 
		{
			if (background == null)
				background = 'white';

			if (text_font==null)
				text_font=='Calibri';

			if (text_color==null)
				text_color=='black';

			if (size==null)
				size=='10px';

			if (indent==null)
				indent=='0px';

			 // Obtiene una referencia a la tabla
			var tableRef = document.getElementById(tableID);

			// Inserta una fila en la tabla, en el índice 0
			var newRow   = tableRef.insertRow(0);
			newRow.style.background = background;

			// Inserta una celda en la fila, en el índice 0
			var newCell  = newRow.insertCell(0);
			var newText  = document.createTextNode(texto);
			newCell.appendChild(newText);
			newCell.style.fontFamily = text_font;
			newCell.style.color = text_color;
			newCell.style.fontSize = size;
			newCell.style.textIndent = indent;
			newCell.setAttribute("id","preguntas"+seccion_id);
		}

		//exportar a excel
		function openExcel() {
			var features = "height=500,width=800,status=no,toolbar=no,menubar=no,location=no,scrollbars=yes,resizable=yes";
			var url = "${def:context}${def:actionroot}/excel?random=" + Math.random();
			var w = window.open(url, null, features);
		}
		
		//exportar a xml
		function openXml(id) {
			var features = "height=500,width=800,status=no,toolbar=no,menubar=no,location=no,scrollbars=yes,resizable=yes";
			var url = "${def:context}${def:actionroot}/xml/search?id=" + id;
			var w = window.open(url, null, features);
		}
		
		//exportar a texto
		function openTxt(id) {
			var features = "height=500,width=800,status=no,toolbar=no,menubar=no,location=no,scrollbars=yes,resizable=yes";
			var url = "${def:context}${def:actionroot}/txt/search?id=" + id;
			var w = window.open(url, null, features);
		}
		
		//envio de emails
		function openEmails() {
			var uri = "${def:context}${def:actionroot}/email/form";					
			openDialog("editor0", uri, 980, 600);	
		}

		//configurar formulario para ingresar registro nuevo
		function addNew()
		{
			document.getElementById("formTitle").innerHTML = "${lbl:b_add_record}";
			document.getElementById("grabar").disabled=false;
			clearForm("form1");
			setFocusOnForm("form1");
		}

		//mostrar la actualizacion de un registro
		function insert()
		{		
				clearErrorMessages();
				document.getElementById("grabar").disabled=true;
				
				//llamada Ajax...
				return ajaxCall(httpMethod="POST", 
								uri="${def:actionroot}/insert", 
								divResponse=null, 
								divProgress="status", 
								formName="form1", 
								afterResponseFn=null, 
								onErrorFn=retryAddnewOrEdit);	
		}

		//restaurar el formulario en caso de error
		function retryAddnewOrEdit() {
			document.getElementById("grabar").disabled=false;
			setFocusOnForm("form1");		
		}

		var id = "${fld:smn_salud_plantilla_cabecera_id}";

		//valida las respuestas del formulario
		function validarRespuestas() {
			var rel_cues_secc_preg_id;
			var variable_id;
			var respuesta_num;
			var respuesta;
			var name;
			var arrayName = [];
			var obligatoriedad;
			var interruptor = false;

			$(".respuestas").each(function(){
				name                  = $(this).attr("name");
				arrayName             = name.split("-");
				respuesta_num         = arrayName[1];
				rel_cues_secc_preg_id = arrayName[2];
				variable_id           = arrayName[3];
				respuesta             = $(this).val();
				obligatoriedad        = $("#obligatoriedad-"+name).val();
				
				if (respuesta == '')
				{
					if (obligatoriedad == 'S') 
					{
						$("#msj-"+name).css("display","");
						interruptor = true;
					}
				}
				else
				{
					$("#msj-"+name).css("display","none");
				}
			});

			if(interruptor == true)
				alertBox("${lbl:b_form_message}","${lbl:b_continue_button}",null,null);
			else
				$("#form1").submit();
		}

		//grabar la cabecera
		function saveCabecera()
		{
			return ajaxCall(httpMethod="POST", 
								uri="${def:actionroot}/insertCabecera", 
								divResponse=null, 
								divProgress="status", 
								formName="form1", 
								afterResponseFn=null, 
								onErrorFn=retryAddnewOrEdit);
		}

		//grabar el detalle
		function saveDetalle()
		{
			var cabecera_id = $("#smn_salud_plantilla_cabecera_id").val();
			var rel_cues_secc_preg_id;
			var variable_id;
			var respuesta;
			var name;
			var arrayName = [];
			var contRespuestas = 0;

			$(".respuestas").each(function(){
				contRespuestas++;

        	    name = $(this).attr("name");
        	    arrayName = name.split("-");
        	    rel_cues_secc_preg_id = arrayName[1];
        	    variable_id = arrayName[2];
        	    respuesta = $(this).val();

        	    ajaxCall(httpMethod="GET", 
						uri="${def:actionroot}/insertDetalle?smn_salud_plantilla_cabecera_id="+cabecera_id+"&smn_rel_cues_secc_preg_id="+rel_cues_secc_preg_id+"&smn_variable_rf="+variable_id+"&spd_valor_respuesta="+respuesta, 
						divResponse=null, 
						divProgress="status", 
						formName="form1", 
						afterResponseFn=null, 
						onErrorFn=retryAddnewOrEdit);

        	    if (contRespuestas==$(".respuestas").length) 
        	    {
        	    	alertBox ('${lbl:b_record_added}: '+cabecera_id, '${lbl:b_continue_button}', null, 'parent.closeDialog();parent.search();');
        	    }
        	});
		}

		//grabar el formulario
		function getReturnId()
		{
			return ajaxCall(httpMethod="POST", 
								uri="${def:actionroot}/insertCabecera/returnId", 
								divResponse=null, 
								divProgress="status", 
								formName="form1", 
								afterResponseFn=null, 
								onErrorFn=retryAddnewOrEdit);
		}

		//editar registro en formulario
		function edit(id)
		{
				clearErrorMessages();

				//llamada Ajax...
				ajaxCall(httpMethod="GET", 
								uri="${def:actionroot}/edit?id=" + id , 
								divResponse=null, 
								divProgress="status", 
								formName=null, 
								afterResponseFn=null, 
								onErrorFn=null);	
		}

		//actualizar registro en BD
		function update()
		{		
				clearErrorMessages();
				document.getElementById("grabar").disabled=true;
				
				//llamada Ajax...
				return ajaxCall(httpMethod="POST", 
								uri="${def:actionroot}/update", 
								divResponse=null, 
								divProgress="status", 
								formName="form1", 
								afterResponseFn=null, 
								onErrorFn=retryAddnewOrEdit);	
		}

	</script>
	
	

</head>

<body>

	<!--banner-->
	<div class="bannerDialog" id="encabezado_tabla">
		${lbl:b_questionnaire}
		<img src="${def:context}/images/close.png" class="button" onclick="parent.closeDialog()" title="${lbl:b_close_button}" style="float:right; cursor:pointer;"/>
	</div>

	<form id="form1" name="form1" onsubmit="return saveCabecera()" style="width:500px;">
		<div id="cuestionario">
			<div id="text_cue">
					
			</div>
			<div id="seccion">
				
			</div>
		</div>
		<input type="hidden" name="smn_cuestionario_rf" value="${fld:id}">
		<input type="hidden" name="smn_auxiliar_rf" value="${fld:smn_auxiliar_rf}">
		<input type="hidden" name="smn_prestador_servicio_rf" value="${fld:smn_prestador_servicio_rf}">
		<input type="hidden" name="smn_ingresos_id" value="${fld:smn_ingresos_id}">
		<input type="hidden" name="spc_nivel_seguridad" value="${fld:cue_nivel_seguridad}">
		<input type="hidden" id="smn_salud_plantilla_cabecera_id" name="smn_salud_plantilla_cabecera_id" value="${fld:smn_salud_plantilla_cabecera_id}">
		<input type="hidden" name="smn_servicios_rf" value="${fld:smn_servicios_rf}">
		<br>
		<div  align="center">
		<!--botones-->
		<input id="grabar" type="button" value="${lbl:b_save_button}" onclick="validarRespuestas()" class="button">
		<input id="limpiar" type="button" value="${lbl:b_clean_button}" onclick="addNew()" class="button">	
		<input id="copiar" type="button" value="${lbl:b_copy_button}" onclick="getFormValuesToCopy('form1')" class="button">
		<input id="pegar" type="button" value="${lbl:b_paste_button}" onclick="getFormValuesToPaste('form1')" class="button">
		<input id="salir" type="button" value="${lbl:s_exit}" onclick="parent.closeDialog(); parent.search();" class="button">
		<!-- PK-->
		<input type="hidden" name="id" value="">
		</div>
	</form>

</body>

</html>
